# Scheduled Tasks
# Runs periodically for maintenance and security

name: Scheduled Tasks

on:
  schedule:
    # Run security scan weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
    # Run dependency updates check daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  # ============================================
  # Security Scanning
  # ============================================
  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true
      
      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # ============================================
  # Dependency Updates Check
  # ============================================
  dependency-check:
    name: üì¶ Check Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - name: Check for outdated packages
        run: |
          echo "## Outdated Packages" >> $GITHUB_STEP_SUMMARY
          npm outdated --json || true
          npm outdated >> $GITHUB_STEP_SUMMARY || echo "All packages up to date!" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Docker Image Vulnerability Scan
  # ============================================
  container-scan:
    name: üê≥ Container Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build image for scanning
        run: docker build -f Dockerfile.optimized -t clinicconnect:scan .
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'clinicconnect:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================
  # Registry Cleanup
  # ============================================
  registry-cleanup:
    name: üßπ Registry Cleanup
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * 0' # Only on Sunday
    
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      
      - name: Run garbage collection
        run: |
          doctl registry garbage-collection start ${{ secrets.DIGITALOCEAN_REGISTRY_NAME }} --force || true
          echo "‚úÖ Registry cleanup initiated"

