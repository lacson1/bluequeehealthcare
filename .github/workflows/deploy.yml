# ClinicConnect CI/CD Pipeline
# Automatically builds, tests, and deploys to DigitalOcean

name: Build & Deploy

on:
  push:
    branches: [main, production]
  pull_request:
    branches: [main]

env:
  REGISTRY: registry.digitalocean.com
  IMAGE_NAME: clinicconnect
  CLUSTER_NAME: clinicconnect-cluster

jobs:
  # ============================================
  # JOB 1: Lint and Type Check
  # ============================================
  lint:
    name: üîç Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript check
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Run ESLint
        run: npm run lint --if-present
        continue-on-error: true

  # ============================================
  # JOB 2: Run Tests
  # ============================================
  test:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: clinicconnect_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run database migrations
        run: npm run db:push --if-present
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/clinicconnect_test

      - name: Run tests
        run: npm test --if-present
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/clinicconnect_test
          NODE_ENV: test

  # ============================================
  # JOB 3: Build Docker Image
  # ============================================
  build:
    name: üê≥ Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production')
    
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ secrets.DIGITALOCEAN_REGISTRY_NAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=production,enable=${{ github.ref == 'refs/heads/production' }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.optimized
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

      - name: Image digest
        run: echo "Image digest - ${{ steps.build.outputs.digest }}"

  # ============================================
  # JOB 4: Deploy to DigitalOcean App Platform
  # ============================================
  deploy-app-platform:
    name: üöÄ Deploy to App Platform
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.app_url }}

    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Deploy to App Platform
        id: deploy
        run: |
          # Trigger deployment
          doctl apps create-deployment ${{ secrets.DIGITALOCEAN_APP_ID }} --wait
          
          # Get app URL
          APP_URL=$(doctl apps get ${{ secrets.DIGITALOCEAN_APP_ID }} --format LiveURL --no-header)
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployed to: $APP_URL"

      - name: Verify deployment
        run: |
          sleep 30
          curl -f ${{ steps.deploy.outputs.app_url }}/api/health || exit 1
          echo "‚úÖ Health check passed!"

  # ============================================
  # JOB 4 (Alternative): Deploy to Droplet via SSH
  # ============================================
  deploy-droplet:
    name: üñ•Ô∏è Deploy to Droplet
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/production'
    environment:
      name: production-droplet
      url: https://${{ secrets.PRODUCTION_DOMAIN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to Container Registry
        run: doctl registry login --expiry-seconds 600

      - name: Deploy to Droplet via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            cd /opt/clinicconnect
            
            # Login to registry
            doctl registry login --expiry-seconds 600
            
            # Pull latest image
            docker pull ${{ env.REGISTRY }}/${{ secrets.DIGITALOCEAN_REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:production
            
            # Update docker-compose with new image
            export IMAGE_TAG=production
            
            # Deploy with zero downtime
            docker compose -f docker-compose.production.yml pull
            docker compose -f docker-compose.production.yml up -d --no-deps --build app
            
            # Cleanup old images
            docker image prune -f
            
            # Health check
            sleep 10
            curl -f http://localhost:5001/api/health || exit 1
            
            echo "‚úÖ Deployment successful!"

      - name: Notify on success
        if: success()
        run: echo "‚úÖ Successfully deployed to production droplet"

      - name: Notify on failure
        if: failure()
        run: echo "‚ùå Deployment failed!"

  # ============================================
  # JOB 5: Database Migration (Optional)
  # ============================================
  migrate:
    name: üóÑÔ∏è Run Migrations
    runs-on: ubuntu-latest
    needs: [deploy-app-platform]
    if: github.ref == 'refs/heads/main' && success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --only=production

      - name: Run migrations
        run: npm run db:push --if-present
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}

  # ============================================
  # JOB 6: Cleanup Old Images
  # ============================================
  cleanup:
    name: üßπ Cleanup Old Images
    runs-on: ubuntu-latest
    needs: [deploy-app-platform, deploy-droplet]
    if: always() && (needs.deploy-app-platform.result == 'success' || needs.deploy-droplet.result == 'success')

    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Run garbage collection
        run: |
          doctl registry garbage-collection start ${{ secrets.DIGITALOCEAN_REGISTRY_NAME }} --force
          echo "‚úÖ Garbage collection started"

